# CRUSH.md - NixOS Configuration Guide

This is a NixOS system configuration managed with Nix Flakes. The configuration is modular, split across multiple `.nix` files that are imported into the main `flake.nix`.

## Project Overview

**Type**: NixOS System Configuration (Flakes-based)  
**User**: alex (Alexander van Zyl)  
**Location**: `~/.nixos` (non-standard location, typical is `/etc/nixos`)  
**Timezone**: Africa/Johannesburg (en_ZA.UTF-8)  
**Window Manager**: AwesomeWM  
**Shell**: Fish

## Essential Commands

### Building and Applying Configuration

```bash
# Test configuration without applying (dry-run)
sudo nixos-rebuild dry-build --flake /home/alex/.nixos#default

# Build configuration without switching
sudo nixos-rebuild build --flake /home/alex/.nixos#default

# Build and switch to new configuration (apply changes)
sudo nixos-rebuild switch --flake /home/alex/.nixos#default

# Build and switch, then set as boot default
sudo nixos-rebuild boot --flake /home/alex/.nixos#default

# Test configuration temporarily (reverts on reboot)
sudo nixos-rebuild test --flake /home/alex/.nixos#default
```

### Flake Management

```bash
# Update all flake inputs (nixpkgs, neovim-nightly, etc.)
nix flake update /home/alex/.nixos

# Update specific input only
nix flake lock --update-input nixpkgs /home/alex/.nixos
nix flake lock --update-input neovim-nightly-overlay /home/alex/.nixos

# Show flake metadata
nix flake show /home/alex/.nixos

# Check flake for errors
nix flake check /home/alex/.nixos
```

### System Information

```bash
# Show current generation
nixos-rebuild list-generations

# Roll back to previous generation
sudo nixos-rebuild switch --rollback

# Garbage collection (remove old generations)
sudo nix-collect-garbage -d

# Optimize nix store
sudo nix-store --optimize
```

## File Structure

```
.nixos/
├── flake.nix          # Main flake definition, inputs, and module imports
├── flake.lock         # Lock file for reproducible builds
├── root.nix           # System-wide settings (swap, nix settings, system packages, fonts)
├── alex.nix           # User configuration (packages, shell, groups, docker)
├── services.nix       # System services (X11, bluetooth, audio, polkit, cron)
├── network.nix        # Network configuration (firewall, SSH, VPN, DNS)
├── gpu.nix            # NVIDIA GPU configuration
└── cpu.nix            # CPU power management
```

### Module Responsibilities

**flake.nix**
- Defines flake inputs: nixpkgs (unstable), neovim-nightly-overlay, yazi, zen-browser
- Creates `nixosConfigurations.default` configuration
- Imports `/etc/nixos/configuration.nix` (hardware-specific, pre-generated by NixOS installer)
- Imports all custom modules (root, network, gpu, cpu, services, alex)
- Applies overlays (neovim-nightly)

**root.nix**
- 32GB swap file at `/var/lib/swapfile`
- Enables experimental features: `nix-command` and `flakes`
- System-wide packages (development tools, utilities, CLI tools)
- Allows unfree packages (`nixpkgs.config.allowUnfree = true`)
- Font configuration (JetBrains Mono Nerd Font)
- Neovim nightly via overlay
- Manpages and documentation
- Ftrace kernel setting
- TODO: Nix build settings (cores/max-jobs) may not be working

**alex.nix**
- User "alex" configuration (group, shell, description)
- User groups: networkmanager, wheel, docker
- User-specific packages (GUI apps, dev tools, gaming)
- System activation scripts for `/bin/bash` and `/usr/bin/python3` symlinks
- Docker virtualization enabled
- Fish shell enabled
- NoiseTouch enabled
- Steam and gaming configuration (gamemode, gamescope)

**services.nix**
- Bluetooth (enabled, power on boot)
- X server (layout: za, caps:escape, autorepeat timing)
- AwesomeWM window manager with lua modules
- Ly display manager (with custom settings)
- Printing (CUPS)
- Audio (PipeWire, replaces PulseAudio)
- Touchpad support (libinput)
- Cron (runs polybar loadshedding script)
- Polkit with gnome authentication agent
- ClamAV (scanner + updater, daemon disabled)
- GVFS and udisks2 for drive mounting
- TODO: xkb caps:escape might not work

**network.nix**
- Hostname: "nixos"
- NetworkManager enabled
- Firewall: TCP ports 80, 443, 3128 (squid proxy for TSN)
- SSH with fail2ban (max 5 retries, permanent ban)
- OpenVPN server configuration for office VPN (manual start)
- DNS: Cloudflare (1.1.1.1) and Google (8.8.8.8)

**gpu.nix**
- NVIDIA proprietary drivers (open=false)
- Modesetting enabled
- Force full composition pipeline
- Stable driver with libtirpc patch
- Power management disabled
- nvidia-persistenced enabled
- TODO: Intel + NVIDIA hybrid setup breaks

**cpu.nix**
- Power management enabled (powertop disabled)
- CPU frequency governor: "powersave"
- Max frequency: 10GHz (10000000)
- Thermald enabled

## Configuration Patterns

### Adding System Packages

System-wide packages go in `root.nix` in the `environment.systemPackages` list:

```nix
environment.systemPackages = [
  pkgs.package-name
];
```

### Adding User Packages

User-specific packages go in `alex.nix` in the `users.users.alex.packages` list:

```nix
users.users.alex = {
  packages = [
    pkgs.package-name
  ];
};
```

### Package Overrides

Package overrides are defined in `root.nix` under `nixpkgs.config.packageOverrides`:

```nix
nixpkgs.config = {
  packageOverrides = pkgs: {
    polybar = pkgs.polybar.override {
      pulseSupport = true;
    };
  };
};
```

### Using Flake Inputs

External flake inputs are referenced via `inputs` parameter:

```nix
{ pkgs, inputs, ... }:
{
  environment.systemPackages = [
    inputs.zen-browser.packages."${pkgs.system}".default
  ];
}
```

### Service Configuration

Services are configured in `services.nix` using the standard NixOS services options:

```nix
services.serviceName = {
  enable = true;
  # service-specific options
};
```

### Hardware Configuration

Hardware-specific settings (GPU, CPU) are isolated in separate files (`gpu.nix`, `cpu.nix`) for modularity.

## Important Conventions

### Indentation and Formatting
- **Indentation**: Mix of spaces and tabs observed (inconsistent)
- **2 spaces**: Most common indentation
- **Tabs**: Used in flake.nix line 7 (yazi input)
- **Brace style**: Opening brace on same line `{ ... }:`
- **List formatting**: One item per line in lists

### Comments
- `# Comment` for single-line comments
- `TODO:` prefix for known issues or future work
- Inline comments for configuration explanations

### Naming
- **Files**: lowercase with hyphens (though this repo uses `.nix` extension only)
- **Attributes**: camelCase for NixOS options, following upstream conventions
- **Users/Groups**: lowercase (alex, wheel, docker)

### Module Function Signatures
All modules follow the pattern:
```nix
{ pkgs, ... }:          # Minimal, only pkgs needed
{ pkgs, inputs, ... }:  # When using flake inputs
{ config, pkgs, ... }:  # When referencing other options
```

## Development Tools Installed

### Languages and Runtimes
- **Go**: gopls, go
- **Python**: python3, pyright, pylint, flake8, black
- **Rust**: rustc, cargo, rust-analyzer, rustfmt
- **Zig**: zig, zls
- **C/C++**: gcc, clang, clang-tools, ccls, cppcheck, gdb
- **Java**: zulu (JDK), zulu8
- **Node.js**: nodejs, typescript-language-server, eslint
- **Lua**: lua-language-server, luacheck, stylua

### Build Tools
- cmake, cmake-language-server
- ninja
- gnumake

### Infrastructure
- Docker (docker-compose, lazydocker)
- Terraform (terraform, terraform-ls)
- AWS CLI (awscli2)

### Language Servers
- nixd (Nix)
- gopls (Go)
- pyright (Python)
- rust-analyzer (Rust)
- zls (Zig)
- typescript-language-server (TypeScript)
- bash-language-server (Bash)
- yaml-language-server (YAML)
- clang-tools (C/C++)
- lua-language-server (Lua)
- dockerfile-language-server (Docker)
- vscode-langservers-extracted (HTML/CSS/JSON)

### Developer CLI Tools
- git, gh (GitHub CLI), glab (GitLab CLI)
- lazygit (Git TUI)
- delta, difftastic (Git diff tools)
- ripgrep, fd, fzf
- jq (JSON processor)
- buf, protobuf, grpcurl (Protocol Buffers/gRPC)
- tokei (code statistics)
- btop, nvtop (system monitors)
- atuin (shell history)
- zoxide, starship (shell enhancements)

## Known Issues (TODOs)

1. **root.nix**: Nix build settings (`cores = 5`, `max-jobs = 2`) may not be working
2. **root.nix**: Sorting system packages list needed
3. **root.nix**: pinentry-curses might need to be gnome variant
4. **services.nix**: xkb caps:escape option might not work
5. **gpu.nix**: Intel + NVIDIA hybrid driver setup breaks system
6. **gpu.nix**: NVIDIA package override needed due to build failure (libtirpc workaround)

## External Dependencies

### Flake Inputs
- **nixpkgs**: nixos-unstable channel
- **neovim-nightly-overlay**: Nightly builds of Neovim
- **yazi**: File manager
- **zen-browser**: Browser (while waiting for stable)

### System Integration
- `/etc/nixos/configuration.nix`: Hardware configuration (generated by NixOS installer)
- `/etc/openvpn/TSN_SA.ovpn`: VPN configuration file (external, not in repo)
- `~/.config/polybar/scripts/update_loadshedding.sh`: Polybar script (external)

## Rebuild Workflow

1. Edit relevant `.nix` file(s)
2. **Validate**: `nix flake check /home/alex/.nixos`
3. **Test build**: `sudo nixos-rebuild dry-build --flake /home/alex/.nixos#default`
4. **Apply**: `sudo nixos-rebuild switch --flake /home/alex/.nixos#default`
5. If system breaks, reboot and select previous generation from bootloader

## Security Notes

- **Unfree packages**: Allowed globally (`allowUnfree = true`)
- **SSH**: Password authentication enabled, protected by fail2ban (permanent ban after 5 attempts)
- **Firewall**: Enabled with specific ports allowed (80, 443, 3128)
- **ClamAV**: Virus scanner enabled, auto-updates
- **Polkit**: Enabled for privilege escalation with gnome agent
- **Docker**: User "alex" in docker group (can run containers without sudo)

## Gaming Configuration

- **Steam**: Enabled with gamescope session
- **Gamemode**: Enabled for performance optimization
- **Compatibility tools**: Proton tools path configured
- **Launchers**: Lutris, Heroic (Epic Games), Bottles (Wine)
- **Monitoring**: MangoHud for FPS/performance overlay
- **Tool**: protonup-ng for managing Proton versions

## Typical Modification Examples

### Adding a New Package
```nix
# In alex.nix, add to packages list:
pkgs.new-package-name
```

### Enabling a New Service
```nix
# In services.nix:
services.new-service = {
  enable = true;
  # configuration options
};
```

### Changing System Settings
```nix
# In root.nix for system-wide
# In alex.nix for user-specific
```

### Updating Dependencies
```bash
nix flake update /home/alex/.nixos
sudo nixos-rebuild switch --flake /home/alex/.nixos#default
```

## Troubleshooting

### Build Fails
1. Check syntax: `nix flake check /home/alex/.nixos`
2. Review error messages for missing attributes or syntax errors
3. Validate package names exist in nixpkgs
4. Check if options are supported in your nixpkgs version

### System Doesn't Boot
1. Reboot and select previous generation from bootloader
2. Roll back: `sudo nixos-rebuild switch --rollback`

### Service Doesn't Start
1. Check service status: `systemctl status service-name`
2. View logs: `journalctl -u service-name`
3. Verify service configuration in relevant `.nix` file

### Package Not Found
1. Search nixpkgs: `nix search nixpkgs package-name`
2. Check if package exists in nixos-unstable
3. Verify correct attribute path (e.g., `pkgs.python3Packages.package-name`)

## Additional Resources

- NixOS Manual: https://nixos.org/manual/nixos/stable/
- Nix Package Search: https://search.nixos.org/packages
- NixOS Options Search: https://search.nixos.org/options
- Flakes Wiki: https://nixos.wiki/wiki/Flakes
